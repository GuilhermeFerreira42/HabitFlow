<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitFlow | Controle de Hábitos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50%' y='50%' style='font-size: 90px;' text-anchor='middle' dominant-baseline='middle'>🚀</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* Estilos para o calendário mensal */
        .calendar-day.logged { background-color: #2563eb; color: white; border-radius: 50%; font-weight: bold; }
        .calendar-day.today { border: 2px solid #34d399; }
        /* Estilos para o calendário anual */
        .annual-day.logged { background-color: #2563eb; color: white; }
        .annual-day.today { box-shadow: 0 0 0 2px #34d399; }

        #loading-overlay.fade-out { opacity: 0; transition: opacity 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <div id="loading-overlay" class="fixed top-0 left-0 w-full h-full bg-gray-900 flex justify-center items-center z-50 px-4">
        <div class="w-full max-w-md">
            <h2 class="text-white text-2xl font-bold text-center mb-3"><i class="fa-solid fa-rocket text-blue-400"></i> HabitFlow</h2>
            <div class="bg-gray-700 rounded-full h-4 overflow-hidden"><div id="progress-bar-inner" class="bg-gradient-to-r from-blue-500 to-teal-400 h-4 rounded-full text-center text-xs text-white flex items-center justify-center transition-all duration-300" style="width: 0%;">0%</div></div>
            <p id="loading-status" class="text-center text-gray-400 text-sm mt-2">Inicializando...</p>
        </div>
    </div>

    <div id="log-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 w-full max-w-md">
            <h3 id="log-modal-title" class="text-2xl font-bold mb-4 text-white">Registrar Hábito</h3>
            <form id="log-form">
                <input type="hidden" id="log-habit-id">
                <div class="mb-4">
                    <label for="log-datetime" class="block text-sm font-medium text-gray-300 mb-2">Data e Hora da Realização</label>
                    <input type="datetime-local" id="log-datetime" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="log-notes" class="block text-sm font-medium text-gray-300 mb-2">Anotação do Registro (Opcional)</label>
                    <textarea id="log-notes" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Como você se sentiu? Algum detalhe?"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-log-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Salvar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <div class="flex">
        <aside id="sidebar" class="bg-gray-800 text-white w-72 h-screen fixed top-0 left-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out overflow-y-auto">
            <div class="p-4 border-b border-gray-700"><h1 class="text-2xl font-bold text-center"><i class="fa-solid fa-rocket text-blue-400"></i> HabitFlow</h1></div>
            <nav id="nav-menu" class="p-4 space-y-2">
                <button data-target="dashboard" class="nav-button w-full flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-chart-bar w-6 text-center"></i><span class="ml-4 font-semibold">Visão Geral</span></button>
                <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase">Meus Hábitos</div>
                <div id="habit-buttons-container" class="space-y-1"></div>
                <div class="p-2 mt-2">
                    <form id="add-habit-form" class="flex gap-2">
                        <input type="text" id="new-habit-name" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Novo hábito..." required>
                        <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold p-2 rounded-lg transition-colors" aria-label="Adicionar Hábito"><i class="fas fa-plus"></i></button>
                    </form>
                </div>
            </nav>
        </aside>

        <main id="main-content" class="flex-1 md:ml-72 p-4 md:p-8 transition-all duration-300 ease-in-out">
            <header class="flex justify-between items-center mb-8">
                <button id="hamburger-button" class="md:hidden text-2xl p-2"><i class="fas fa-bars"></i></button>
                <h2 id="content-title" class="text-3xl font-bold text-white"></h2>
            </header>

            <section id="dashboard-content" class="content-section">
                 <div id="habit-streaks-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg mt-8">
                    <h3 class="text-lg font-semibold mb-4">Gerenciamento de Dados</h3>
                    <div class="flex flex-wrap gap-4">
                        <button id="download-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-download mr-2"></i>Baixar Backup (JSON)</button>
                        <button id="upload-data-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-upload mr-2"></i>Carregar Backup (JSON)</button>
                        <input type="file" id="upload-input" accept=".json" class="hidden">
                        <button id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-trash-alt mr-2"></i>Limpar Dados</button>
                    </div>
                </div>
            </section>
            
            <div id="habit-pages-container"></div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURAÇÃO DA APLICAÇÃO ---
    const DB_NAME = 'habitflow-db-v2';
    const DB_VERSION = 1;
    const HABITS_STORE = 'habits';
    const LOGS_STORE = 'logs';
    const HABIT_NOTES_STORE = 'habit_notes';
    let db;
    let activeStreakIntervals = {};

    // --- ELEMENTOS DO DOM ---
    const contentTitle = document.getElementById('content-title');
    const habitButtonsContainer = document.getElementById('habit-buttons-container');
    const habitPagesContainer = document.getElementById('habit-pages-container');
    const habitStreaksContainer = document.getElementById('habit-streaks-container');

    // Modal
    const logModal = document.getElementById('log-modal');
    const logForm = document.getElementById('log-form');
    const logModalTitle = document.getElementById('log-modal-title');
    const logHabitIdInput = document.getElementById('log-habit-id');
    const logDateTimeInput = document.getElementById('log-datetime');
    const logNotesInput = document.getElementById('log-notes');

    // --- FUNÇÕES DO BANCO DE DADOS (INDEXEDDB) ---
    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => reject('Erro ao abrir o IndexedDB.');
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(HABITS_STORE)) {
                    db.createObjectStore(HABITS_STORE, { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains(LOGS_STORE)) {
                    const logsStore = db.createObjectStore(LOGS_STORE, { keyPath: 'id', autoIncrement: true });
                    logsStore.createIndex('habitId_idx', 'habitId', { unique: false });
                }
                if (!db.objectStoreNames.contains(HABIT_NOTES_STORE)) {
                    const notesStore = db.createObjectStore(HABIT_NOTES_STORE, { keyPath: 'id', autoIncrement: true });
                    notesStore.createIndex('habitId_idx', 'habitId', { unique: false });
                }
            };
        });
    }

    // --- LÓGICA DE HÁBITOS ---
    async function handleAddHabit(event) {
        event.preventDefault();
        const input = document.getElementById('new-habit-name');
        const habitName = input.value.trim();
        if (!habitName) return;

        const newHabit = { name: habitName, createdAt: new Date() };
        await addToDB(db.transaction(HABITS_STORE, 'readwrite').objectStore(HABITS_STORE), newHabit);
        
        input.value = '';
        await loadAndDisplayHabits();
        await updateDashboard();
    }
    
    async function loadAndDisplayHabits() {
        habitButtonsContainer.innerHTML = '';
        habitPagesContainer.innerHTML = '';
        const habits = await getAllFromDB(db.transaction(HABITS_STORE, 'readonly').objectStore(HABITS_STORE));
        
        habits.forEach(habit => {
            const button = document.createElement('button');
            button.className = 'nav-button w-full flex items-center p-2 pl-6 rounded-lg hover:bg-gray-700 transition-colors duration-200';
            button.dataset.target = `habit-${habit.id}`;
            button.innerHTML = `<i class="fa-solid fa-bullseye w-5 text-center"></i><span class="ml-3 font-medium">${habit.name}</span>`;
            habitButtonsContainer.appendChild(button);
            createHabitPage(habit);
        });
    }

    function createHabitPage(habit) {
        const section = document.createElement('section');
        section.id = `habit-${habit.id}-content`;
        section.className = 'content-section hidden';
        section.dataset.isAnnualView = 'false'; // Estado da visualização do calendário

        section.innerHTML = `
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-white">Calendário</h3>
                    <button data-action="toggle-view" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Ver Visão Anual</button>
                </div>
                <div id="calendar-view-container-${habit.id}">
                    <div id="monthly-view-${habit.id}">
                         <div class="flex justify-between items-center mb-6">
                            <button data-action="prev-month" class="calendar-nav-btn text-xl p-2 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="calendar-title-${habit.id}" class="text-2xl font-bold text-white text-center"></h3>
                            <button data-action="next-month" class="calendar-nav-btn text-xl p-2 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center font-bold text-sm text-gray-400 py-2">
                            ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(day => `<div>${day}</div>`).join('')}
                        </div>
                        <div id="calendar-grid-${habit.id}" class="grid grid-cols-7 gap-2 text-center"></div>
                    </div>
                    <div id="annual-view-${habit.id}" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                             <button data-action="prev-year" class="calendar-nav-btn text-xl p-2 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-700 transition-colors"><i class="fas fa-angle-double-left"></i></button>
                             <h3 id="annual-title-${habit.id}" class="text-2xl font-bold text-white text-center"></h3>
                             <button data-action="next-year" class="calendar-nav-btn text-xl p-2 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-700 transition-colors"><i class="fas fa-angle-double-right"></i></button>
                        </div>
                        <div id="annual-grid-${habit.id}" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-white mb-4">Anotações do Hábito</h3>
                    <form data-action="add-note" class="mb-4">
                        <textarea class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Adicione uma anotação sobre este hábito..." required></textarea>
                        <button type="submit" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full">Salvar Anotação</button>
                    </form>
                    <div id="habit-notes-list-${habit.id}" class="space-y-3 max-h-72 overflow-y-auto pr-2"></div>
                </div>

                <div class="space-y-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-lg font-semibold text-teal-300 mb-2">SEQUÊNCIA ATUAL</h3>
                        <div id="streak-display-${habit.id}" class="text-4xl font-bold font-mono">0d 0h 0m 0s</div>
                    </div>
                     <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                         <h3 class="text-lg font-semibold text-white mb-4">Registros Recentes</h3>
                         <div id="logs-list-${habit.id}" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>`;
        habitPagesContainer.appendChild(section);
    }

    // --- LÓGICA DE ANOTAÇÕES DO HÁBITO (CRUD) ---
    async function handleHabitNoteSubmit(form, habitId) {
        const textarea = form.querySelector('textarea');
        const text = textarea.value.trim();
        if (!text) return;

        const note = { habitId, text, timestamp: Date.now() };
        await addToDB(db.transaction(HABIT_NOTES_STORE, 'readwrite').objectStore(HABIT_NOTES_STORE), note);
        textarea.value = '';
        await renderHabitNotes(habitId);
    }

    async function renderHabitNotes(habitId) {
        const listContainer = document.getElementById(`habit-notes-list-${habitId}`);
        if (!listContainer) return;
        
        const tx = db.transaction(HABIT_NOTES_STORE, 'readonly');
        const index = tx.objectStore(HABIT_NOTES_STORE).index('habitId_idx');
        const notes = await getAllFromIndexDB(index, habitId);
        notes.sort((a,b) => b.timestamp - a.timestamp);

        listContainer.innerHTML = notes.length === 0
            ? '<p class="text-gray-500 text-center">Nenhuma anotação para este hábito.</p>'
            : notes.map(note => `
                <div class="bg-gray-700/50 p-3 rounded-lg" id="note-${note.id}">
                    <p class="text-gray-300 whitespace-pre-wrap">${note.text}</p>
                    <div class="text-right text-xs text-gray-500 mt-2 flex justify-between items-center">
                        <span>${new Date(note.timestamp).toLocaleString('pt-BR')}</span>
                        <div>
                            <button data-action="edit-note" data-note-id="${note.id}" class="hover:text-blue-400 px-1">Editar</button>
                            <button data-action="delete-note" data-note-id="${note.id}" class="hover:text-red-400 px-1">Excluir</button>
                        </div>
                    </div>
                </div>
            `).join('');
    }

    async function handleNoteEdit(noteId, habitId) {
        const note = await getFromDB(db.transaction(HABIT_NOTES_STORE, 'readonly').objectStore(HABIT_NOTES_STORE), noteId);
        const newText = prompt("Edite sua anotação:", note.text);
        if (newText && newText.trim() !== note.text) {
            note.text = newText.trim();
            await updateInDB(db.transaction(HABIT_NOTES_STORE, 'readwrite').objectStore(HABIT_NOTES_STORE), note);
            await renderHabitNotes(habitId);
        }
    }

    async function handleNoteDelete(noteId, habitId) {
        if (confirm("Tem certeza que deseja excluir esta anotação?")) {
            await deleteFromDB(db.transaction(HABIT_NOTES_STORE, 'readwrite').objectStore(HABIT_NOTES_STORE), noteId);
            await renderHabitNotes(habitId);
        }
    }


    // --- LÓGICA DE CÁLCULO DE SEQUÊNCIA (STREAK) ---
    function stopAllStreakIntervals() {
        Object.values(activeStreakIntervals).forEach(clearInterval);
        activeStreakIntervals = {};
    }

    function startStreakInterval(habitId, firstLogTime) {
        if (activeStreakIntervals[habitId]) {
            clearInterval(activeStreakIntervals[habitId]);
        }
        
        const update = () => {
            const duration = Date.now() - firstLogTime;
            const days = Math.floor(duration / 86400000); // 1000 * 60 * 60 * 24
            const hours = Math.floor((duration % 86400000) / 3600000); // 1000 * 60 * 60
            const minutes = Math.floor((duration % 3600000) / 60000); // 1000 * 60
            const seconds = Math.floor((duration % 60000) / 1000);
            
            const text = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            
            const streakDisplayPage = document.getElementById(`streak-display-${habitId}`);
            const streakDisplayDash = document.getElementById(`dashboard-streak-${habitId}`);

            if(streakDisplayPage) streakDisplayPage.textContent = text;
            if(streakDisplayDash) streakDisplayDash.textContent = text;
        };

        update(); // Primeira chamada imediata
        activeStreakIntervals[habitId] = setInterval(update, 1000);
    }

    async function calculateAndDisplayStreak(habitId) {
        const tx = db.transaction(LOGS_STORE, 'readonly');
        const index = tx.objectStore(LOGS_STORE).index('habitId_idx');
        const logs = await getAllFromIndexDB(index, habitId);
        
        const streakDisplayPage = document.getElementById(`streak-display-${habitId}`);
        const streakDisplayDash = document.getElementById(`dashboard-streak-${habitId}`);

        function setStreakText(text) {
            if(streakDisplayPage) streakDisplayPage.textContent = text;
            if(streakDisplayDash) streakDisplayDash.textContent = text;
            if (activeStreakIntervals[habitId]) {
                 clearInterval(activeStreakIntervals[habitId]);
                 delete activeStreakIntervals[habitId];
            }
        }

        if (logs.length === 0) {
            setStreakText("Nenhum registro");
            return;
        }
        
        logs.sort((a, b) => b.timestamp - a.timestamp);

        if (Date.now() - logs[0].timestamp > 24 * 60 * 60 * 1000) {
            setStreakText("Sequência quebrada");
            return;
        }

        let firstLogTime = logs[0].timestamp;
        for (let i = 0; i < logs.length - 1; i++) {
            if (logs[i].timestamp - logs[i+1].timestamp > 24 * 60 * 60 * 1000) {
                break;
            }
            firstLogTime = logs[i+1].timestamp;
        }
        startStreakInterval(habitId, firstLogTime);
    }

    // --- LÓGICA DE REGISTRO (LOG) E MODAL ---
    function openLogModal(habitId, dateStr) {
        const habitName = document.querySelector(`.nav-button[data-target='habit-${habitId}'] span`).textContent;
        logModalTitle.textContent = `Registrar "${habitName}"`;
        logHabitIdInput.value = habitId;

        const now = new Date();
        const date = new Date(dateStr);
        // Mantém a hora atual, mas no dia selecionado
        date.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

        const timezoneOffset = date.getTimezoneOffset() * 60000;
        const localISOTime = new Date(date - timezoneOffset).toISOString().slice(0, 16);
        
        logDateTimeInput.value = localISOTime;
        logNotesInput.value = '';
        logModal.classList.remove('hidden');
    }

    function closeLogModal() {
        logModal.classList.add('hidden');
    }

    async function handleLogSubmit(event) {
        event.preventDefault();
        const habitId = parseInt(logHabitIdInput.value);
        const timestamp = new Date(logDateTimeInput.value).getTime();
        const notes = logNotesInput.value.trim();

        const newLog = { habitId, timestamp, notes };
        await addToDB(db.transaction(LOGS_STORE, 'readwrite').objectStore(LOGS_STORE), newLog);
        
        closeLogModal();
        await updateHabitPage(habitId, new Date(timestamp));
        await updateDashboard();
    }
    
    async function handleLogDelete(logId, habitId) {
        if(confirm("Tem certeza que deseja excluir este registro?")) {
            const log = await getFromDB(db.transaction(LOGS_STORE, 'readonly').objectStore(LOGS_STORE), logId);
            await deleteFromDB(db.transaction(LOGS_STORE, 'readwrite').objectStore(LOGS_STORE), logId);
            await updateHabitPage(habitId, new Date(log.timestamp));
            await updateDashboard();
        }
    }

    // --- LÓGICA DE CALENDÁRIO (MENSAL E ANUAL) ---
    async function renderCalendar(habitId, date, isAnnual) {
        const monthlyView = document.getElementById(`monthly-view-${habitId}`);
        const annualView = document.getElementById(`annual-view-${habitId}`);
        if (!monthlyView || !annualView) return;

        const allLogs = await getAllFromIndexDB(db.transaction(LOGS_STORE, 'readonly').objectStore(LOGS_STORE).index('habitId_idx'), habitId);
        const loggedDates = new Set(allLogs.map(log => new Date(log.timestamp).toDateString()));
        const todayString = new Date().toDateString();

        if (isAnnual) {
            monthlyView.classList.add('hidden');
            annualView.classList.remove('hidden');
            document.querySelector(`#habit-${habitId}-content [data-action='toggle-view']`).textContent = "Ver Visão Mensal";
            renderAnnualView(habitId, date.getFullYear(), loggedDates, todayString);
        } else {
            annualView.classList.add('hidden');
            monthlyView.classList.remove('hidden');
            document.querySelector(`#habit-${habitId}-content [data-action='toggle-view']`).textContent = "Ver Visão Anual";
            renderMonthlyView(habitId, date, loggedDates, todayString);
        }
    }

    function renderMonthlyView(habitId, date, loggedDates, todayString) {
        const calendarGrid = document.getElementById(`calendar-grid-${habitId}`);
        const calendarTitle = document.getElementById(`calendar-title-${habitId}`);
        
        const month = date.getMonth();
        const year = date.getFullYear();
        calendarTitle.textContent = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
        
        calendarGrid.innerHTML = '';
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.innerHTML += '<div></div>';
        
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const dateString = currentDate.toDateString();
            const dateForAttr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            let classes = 'calendar-day h-10 w-10 flex items-center justify-center rounded-full cursor-pointer transition-colors hover:bg-gray-700';
            if (loggedDates.has(dateString)) classes += ' logged';
            if (dateString === todayString) classes += ' today';

            calendarGrid.innerHTML += `<div class="${classes}" data-date="${dateForAttr}">${day}</div>`;
        }
    }

    function renderAnnualView(habitId, year, loggedDates, todayString) {
        const annualGrid = document.getElementById(`annual-grid-${habitId}`);
        document.getElementById(`annual-title-${habitId}`).textContent = `Ano de ${year}`;
        annualGrid.innerHTML = '';

        for (let month = 0; month < 12; month++) {
            const monthName = new Date(year, month).toLocaleString('pt-BR', { month: 'long' });
            let monthHTML = `<div class="bg-gray-700/50 p-3 rounded-lg"><h4 class="font-bold text-center mb-2">${monthName.replace(/^\w/, c => c.toUpperCase())}</h4>`;
            monthHTML += `<div class="grid grid-cols-7 gap-1 text-center text-xs">`;
            ['D','S','T','Q','Q','S','S'].forEach(d => { monthHTML += `<div class="font-semibold text-gray-500">${d}</div>`; });
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDayOfMonth; i++) monthHTML += '<div></div>';

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateString = currentDate.toDateString();
                const dateForAttr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                let classes = 'annual-day h-6 w-6 flex items-center justify-center rounded-full cursor-pointer transition-colors hover:bg-gray-600';
                if (loggedDates.has(dateString)) classes += ' logged';
                if (dateString === todayString) classes += ' today';
                monthHTML += `<div class="${classes}" data-date="${dateForAttr}">${day}</div>`;
            }

            monthHTML += `</div></div>`;
            annualGrid.innerHTML += monthHTML;
        }
    }

    // --- ATUALIZAÇÕES DE UI ---
    async function updateDashboard() {
        stopAllStreakIntervals();
        habitStreaksContainer.innerHTML = '';
        const habits = await getAllFromDB(db.transaction(HABITS_STORE, 'readonly').objectStore(HABITS_STORE));

        if (habits.length === 0) {
            habitStreaksContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 p-8">Crie seu primeiro hábito na barra lateral para começar!</div>';
            return;
        }
        
        for (const habit of habits) {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-between';
            card.innerHTML = `
                <div>
                    <h3 class="font-bold text-xl text-white mb-2">${habit.name}</h3>
                    <p id="dashboard-streak-${habit.id}" class="text-3xl font-bold text-teal-400 font-mono">Calculando...</p>
                </div>
                <button data-target="habit-${habit.id}" class="nav-button mt-4 text-left font-semibold text-blue-400 hover:text-blue-300">Ver detalhes →</button>
            `;
            habitStreaksContainer.appendChild(card);
            calculateAndDisplayStreak(habit.id);
        }
    }
    
    async function updateHabitPage(habitId, calendarDate) {
        const habitPage = document.getElementById(`habit-${habitId}-content`);
        const isAnnual = habitPage.dataset.isAnnualView === 'true';
        
        await renderCalendar(habitId, calendarDate, isAnnual);
        await calculateAndDisplayStreak(habitId);
        await renderHabitNotes(habitId);

        // Atualizar lista de logs
        const logsListContainer = document.getElementById(`logs-list-${habitId}`);
        if (logsListContainer) {
            const tx = db.transaction(LOGS_STORE, 'readonly');
            const index = tx.objectStore(LOGS_STORE).index('habitId_idx');
            const logs = await getAllFromIndexDB(index, habitId);
            logs.sort((a,b) => b.timestamp - a.timestamp); 

            logsListContainer.innerHTML = logs.length === 0
                ? '<p class="text-gray-500 text-center">Nenhum registro ainda.</p>'
                : logs.slice(0, 20).map(log => `
                    <div class="bg-gray-700/50 p-3 rounded-lg text-sm">
                        <p class="text-gray-300">${log.notes || '<i>Sem anotação.</i>'}</p>
                        <div class="text-right text-xs text-gray-500 mt-2 flex justify-between">
                           <span>${new Date(log.timestamp).toLocaleString('pt-BR')}</span>
                           <button data-action="delete-log" data-log-id="${log.id}" class="hover:text-red-400">Excluir</button>
                        </div>
                    </div>
                `).join('');
        }
    }
    
    // --- GERENCIAMENTO DE DADOS ---
    function setupDataManagementListeners() {
        document.getElementById('download-data-btn').addEventListener('click', async () => {
            try {
                const tx = db.transaction([HABITS_STORE, LOGS_STORE, HABIT_NOTES_STORE], 'readonly');
                const [habits, logs, habit_notes] = await Promise.all([
                    getAllFromDB(tx.objectStore(HABITS_STORE)),
                    getAllFromDB(tx.objectStore(LOGS_STORE)),
                    getAllFromDB(tx.objectStore(HABIT_NOTES_STORE))
                ]);
                await tx.done;

                const backupData = { habits, logs, habit_notes };
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `habitflow-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click(); a.remove(); URL.revokeObjectURL(a.href);
                alert('Backup realizado com sucesso!');
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                alert('Ocorreu um erro ao criar o backup.');
            }
        });

        const uploadBtn = document.getElementById('upload-data-btn');
        const uploadInput = document.getElementById('upload-input');
        uploadBtn.addEventListener('click', () => uploadInput.click());
        uploadInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (!data.habits || !data.logs) {
                        throw new Error('Arquivo de backup inválido.');
                    }
                    if (!confirm('Isso irá apagar todos os dados atuais. Deseja continuar?')) return;
                    
                    const storesToRestore = [
                        { name: HABITS_STORE, data: data.habits || [] },
                        { name: LOGS_STORE, data: data.logs || [] },
                        { name: HABIT_NOTES_STORE, data: data.habit_notes || [] }
                    ];

                    for(const storeInfo of storesToRestore) {
                        if(db.objectStoreNames.contains(storeInfo.name)){
                            const tx = db.transaction(storeInfo.name, 'readwrite');
                            const store = tx.objectStore(storeInfo.name);
                            await clearDBStore(store);
                            for(const item of storeInfo.data) { await addToDB(store, item); }
                            await tx.done;
                        }
                    }
                    alert('Dados importados com sucesso! A página será recarregada.');
                    location.reload();
                } catch (error) { alert(`Erro ao processar o arquivo: ${error.message}`); }
            };
            reader.readAsText(file);
        });

        document.getElementById('clear-data-btn').addEventListener('click', async () => {
            if (!confirm("Você tem CERTEZA que deseja apagar TODOS os dados? Esta ação é irreversível.")) return;
            try {
                if (db) db.close();
                const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                deleteRequest.onsuccess = () => { alert('Todos os dados foram apagados! A página será recarregada.'); location.reload(); };
                deleteRequest.onerror = (e) => { console.error("Erro ao apagar DB:", e); alert('Erro ao apagar os dados.'); }
                deleteRequest.onblocked = () => alert('A exclusão foi bloqueada. Feche outras abas com o aplicativo aberto.');
            } catch (error) { alert(`Ocorreu um erro ao apagar os dados: ${error.message}`); }
        });
    }

    // --- NAVEGAÇÃO E EVENT LISTENERS ---
    let currentCalendarDates = {}; 
    
    function handleNavClick(e) {
        const button = e.target.closest('.nav-button');
        if (!button) return;
        
        stopAllStreakIntervals(); // Para todos os contadores ao navegar
        const targetId = button.dataset.target;
        document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));
        const targetSection = document.getElementById(`${targetId}-content`);

        if (targetSection) {
            targetSection.classList.remove('hidden');
            const habitId = parseInt(targetId.substring(6));
            const habitName = button.querySelector('span').textContent;
            contentTitle.textContent = habitName;
            if (!currentCalendarDates[habitId]) {
                currentCalendarDates[habitId] = new Date();
            }
            updateHabitPage(habitId, currentCalendarDates[habitId]);
        } else if (targetId === 'dashboard') {
            contentTitle.textContent = 'Visão Geral';
            updateDashboard();
        }

        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
        button.classList.add('bg-blue-600', 'text-white');
        if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
    }

    function setupEventListeners() {
        document.getElementById('hamburger-button').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
        document.getElementById('nav-menu').addEventListener('click', handleNavClick);
        document.getElementById('add-habit-form').addEventListener('submit', handleAddHabit);
        
        habitPagesContainer.addEventListener('click', e => {
            const habitPage = e.target.closest('.content-section');
            if (!habitPage) return;
            const habitId = parseInt(habitPage.id.split('-')[1]);
            const action = e.target.closest('[data-action]')?.dataset.action;

            switch(action) {
                case 'prev-month':
                case 'next-month':
                case 'prev-year':
                case 'next-year':
                    const isAnnual = habitPage.dataset.isAnnualView === 'true';
                    const date = currentCalendarDates[habitId];
                    if (isAnnual) {
                        date.setFullYear(date.getFullYear() + (action === 'next-year' ? 1 : -1));
                    } else {
                        date.setMonth(date.getMonth() + (action === 'next-month' ? 1 : -1));
                    }
                    renderCalendar(habitId, date, isAnnual);
                    break;
                case 'toggle-view':
                    const willBeAnnual = habitPage.dataset.isAnnualView === 'false';
                    habitPage.dataset.isAnnualView = willBeAnnual;
                    renderCalendar(habitId, currentCalendarDates[habitId], willBeAnnual);
                    break;
                case 'delete-log':
                    handleLogDelete(parseInt(e.target.closest('[data-log-id]').dataset.logId), habitId);
                    break;
                case 'edit-note':
                    handleNoteEdit(parseInt(e.target.closest('[data-note-id]').dataset.noteId), habitId);
                    break;
                case 'delete-note':
                    handleNoteDelete(parseInt(e.target.closest('[data-note-id]').dataset.noteId), habitId);
                    break;
            }

            const dayCell = e.target.closest('.calendar-day, .annual-day');
            if (dayCell) {
                openLogModal(habitId, dayCell.dataset.date);
            }
        });
        
        habitPagesContainer.addEventListener('submit', e => {
            e.preventDefault();
            const habitPage = e.target.closest('.content-section');
            if (!habitPage) return;
            const habitId = parseInt(habitPage.id.split('-')[1]);
            const action = e.target.closest('form')?.dataset.action;
            if (action === 'add-note') {
                handleHabitNoteSubmit(e.target, habitId);
            }
        });

        habitStreaksContainer.addEventListener('click', e => {
             const navButton = e.target.closest('.nav-button');
             if (navButton && navButton.dataset.target) {
                 document.querySelector(`.nav-button[data-target='${navButton.dataset.target}']`).click();
             }
        });

        // Listeners do Modal
        logForm.addEventListener('submit', handleLogSubmit);
        document.getElementById('cancel-log-btn').addEventListener('click', closeLogModal);
        
        setupDataManagementListeners();
    }
    
    // --- FUNÇÕES UTILITÁRIAS DO DB ---
    function getFromDB(store, id) { return new Promise((r,j) => { const req = store.get(id); req.onsuccess = () => r(req.result); req.onerror = () => j(req.error); }); }
    function getAllFromDB(store) { return new Promise((r,j) => { const req = store.getAll(); req.onsuccess = () => r(req.result); req.onerror = () => j(req.error); }); }
    function getAllFromIndexDB(index, query) { return new Promise((r,j) => { const req = index.getAll(query); req.onsuccess = () => r(req.result); req.onerror = () => j(req.error); }); }
    function addToDB(store, value) { return new Promise((r,j) => { const req = store.add(value); req.onsuccess = () => r(req.result); req.onerror = () => j(req.error); }); }
    function updateInDB(store, value) { return new Promise((r,j) => { const req = store.put(value); req.onsuccess = () => r(req.result); req.onerror = () => j(req.error); }); }
    function deleteFromDB(store, id) { return new Promise((r,j) => { const req = store.delete(id); req.onsuccess = () => r(); req.onerror = () => j(req.error); }); }
    function clearDBStore(store) { return new Promise((r,j) => { const req = store.clear(); req.onsuccess = () => r(); req.onerror = () => j(req.error); }); }

    // --- INICIALIZAÇÃO DA APLICAÇÃO ---
    function updateProgressBar(percentage, statusText) {
        document.getElementById('progress-bar-inner').style.width = `${percentage}%`;
        document.getElementById('progress-bar-inner').textContent = `${percentage}%`;
        document.getElementById('loading-status').textContent = statusText;
    }
    
    async function init() {
        try {
            const loadingOverlay = document.getElementById('loading-overlay');
            updateProgressBar(10, 'Abrindo banco de dados...');
            await openDB();
            updateProgressBar(30, 'Carregando seus hábitos...');
            await loadAndDisplayHabits();
            updateProgressBar(60, 'Configurando interações...');
            setupEventListeners();
            updateProgressBar(80, 'Montando o painel...');
            document.querySelector('.nav-button[data-target="dashboard"]').click();
            await new Promise(resolve => setTimeout(resolve, 200));
            updateProgressBar(100, 'Pronto!');
            await new Promise(resolve => setTimeout(resolve, 400));
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
        } catch (error) {
            console.error('Falha na inicialização:', error);
            document.getElementById('loading-overlay').style.display = 'none';
            document.body.innerHTML = `<div class="text-white text-center p-8">Ocorreu um erro crítico. Verifique as permissões do navegador para o IndexedDB e recarregue a página. Detalhes: ${error}</div>`;
        }
    }

    init();
});
</script>

</body>
</html>