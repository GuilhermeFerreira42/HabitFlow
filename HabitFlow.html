<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#3B82F6',
                        },
                    },
                }
            }
        }
    </script>
    <style>
        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        .habit-card:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* NOVO: Para truncar nomes de hábitos longos (Tarefa 1.2) */
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* NOVO: Para quebrar palavras longas em anotações (Tarefa 1.3) */
        .break-word {
            overflow-wrap: break-word;
            word-wrap: break-word; /* Fallback para navegadores mais antigos */
            word-break: break-word;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex">
    <!-- Barra Lateral -->
    <aside class="w-64 glassmorphism border-r border-white/10 p-4 flex flex-col h-screen sticky top-0">
        <div class="mb-8">
            <h1 class="text-2xl font-bold tracking-wide cursor-pointer" id="logoTitle">HabitFlow</h1>
            <p class="text-sm text-white/60">Seu companheiro de hábitos</p>
        </div>

        <nav class="flex-1">
            <ul class="space-y-2">
                <li>
                    <a href="#" class="flex items-center p-2 rounded-lg hover:bg-white/10 transition" id="dashboardLink">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center p-2 rounded-lg hover:bg-white/10 transition" id="notesLink">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Anotações Gerais
                    </a>
                </li>
                <li class="pt-4 mt-4 border-t border-white/10">
                    <h3 class="text-sm font-semibold text-white/70 mb-2 px-2">MEUS HÁBITOS</h3>
                    <div id="sidebarHabitsList" class="space-y-1">
                    </div>
                </li>
            </ul>
        </nav>

        <div class="mt-auto">
            <h3 class="text-sm font-semibold text-white/70 mb-2">NOVO HÁBITO</h3>
            <form id="newHabitForm" class="space-y-2">
                <input type="text" id="habitName" placeholder="Nome do hábito" class="w-full bg-white/5 border border-white/10 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white rounded-full py-2 px-4 transition">Adicionar</button>
            </form>
        </div>

        <div class="mt-4 pt-4 border-t border-white/10">
            <button id="backupBtn" class="text-sm w-full py-1 px-3 rounded-lg hover:bg-white/10 transition">Backup</button>
            <button id="restoreBtn" class="text-sm w-full py-1 px-3 rounded-lg hover:bg-white/10 transition">Restaurar</button>
            <button id="clearDataBtn" class="text-sm w-full py-1 px-3 rounded-lg hover:bg-white/10 transition text-red-400">Limpar Dados</button>
        </div>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="flex-1 p-6">
        <!-- Dashboard (Visão padrão) -->
        <div id="dashboardView" class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Meus Hábitos</h2>
            </div>

            <div id="habitsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Hábitos serão renderizados aqui via JavaScript -->
                <div class="text-center py-10 text-white/40" id="noHabitsMessage">
                    Nenhum hábito cadastrado. Adicione seu primeiro hábito usando o formulário na barra lateral.
                </div>
            </div>
        </div>

        <!-- Página de Detalhes do Hábito (Oculto inicialmente) -->
        <div id="habitDetailView" class="hidden fade-in">
            <div class="flex items-center mb-6">
                <button id="backToDashboard" class="mr-4 p-2 rounded-full hover:bg-white/10 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h2 id="habitDetailTitle" class="text-xl font-semibold flex items-center">
                    <span id="habitNameTitle"></span>
                    <button id="editHabitName" class="ml-2 p-1 rounded-full hover:bg-white/10 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </h2>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Seção do Calendário -->
                <div class="lg:col-span-2">
                    <div class="glassmorphism border border-white/10 rounded-2xl p-4 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-medium">Registro de Atividades</h3>
                            <div class="flex space-x-2">
                                <button id="monthViewBtn" class="text-sm bg-blue-500 px-3 py-1 rounded-full">Mês</button>
                                <button id="yearViewBtn" class="text-sm bg-white/5 px-3 py-1 rounded-full hover:bg-white/10 transition">Ano</button>
                            </div>
                        </div>

                        <!-- Calendário Mensal -->
                        <div id="monthCalendar" class="fade-in">
                            <div class="grid grid-cols-7 gap-1 mb-2">
                                <div class="text-center text-sm text-white/60">Dom</div>
                                <div class="text-center text-sm text-white/60">Seg</div>
                                <div class="text-center text-sm text-white/60">Ter</div>
                                <div class="text-center text-sm text-white/60">Qua</div>
                                <div class="text-center text-sm text-white/60">Qui</div>
                                <div class="text-center text-sm text-white/60">Sex</div>
                                <div class="text-center text-sm text-white/60">Sáb</div>
                            </div>
                            <div id="monthDays" class="grid grid-cols-7 gap-1">
                                <!-- Dias serão renderizados via JavaScript -->
                            </div>
                        </div>

                        <!-- Calendário Anual -->
                        <div id="yearCalendar" class="hidden fade-in">
                            <div class="grid grid-cols-4 gap-2">
                                <!-- Meses serão renderizados via JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Logs Recentes -->
                    <div class="glassmorphism border border-white/10 rounded-2xl p-4">
                        <h3 class="font-medium mb-4">Logs Recentes</h3>
                        <div id="recentLogs" class="space-y-2">
                            <p class="text-sm text-white/40 text-center py-4">Nenhum registro encontrado</p>
                        </div>
                    </div>
                </div>

                <!-- Seção de Anotações -->
                <div class="lg:col-span-1">
                    <div class="glassmorphism border border-white/10 rounded-2xl p-4 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-medium">Anotações do Hábito</h3>
                            <button id="addNoteBtn" class="text-sm bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded-full transition">+ Nova</button>
                        </div>
                        <div id="habitNotes" class="space-y-3 flex-1 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Anotações Gerais (Oculto inicialmente) -->
        <div id="generalNotesView" class="hidden fade-in">
            <div class="flex items-center mb-6">
                <button id="backFromNotes" class="mr-4 p-2 rounded-full hover:bg-white/10 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h2 class="text-xl font-semibold">Anotações Gerais</h2>
            </div>

            <div class="glassmorphism border border-white/10 rounded-2xl p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-medium">Todas as Anotações</h3>
                    <button id="addGeneralNoteBtn" class="text-sm bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded-full transition">+ Nova</button>
                </div>
                <div id="generalNotesList" class="space-y-3">
                    <p class="text-sm text-white/40 text-center py-4">Nenhuma anotação encontrada</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Universal -->
    <div id="universalModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="glassmorphism border border-white/10 rounded-2xl p-6 w-full max-w-md">
            <h3 id="modalTitle" class="text-lg font-semibold mb-4">Editar</h3>
            <textarea id="modalInput" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4" rows="4"></textarea>
            <div class="flex justify-end space-x-2">
                <button id="modalCancel" class="px-4 py-2 rounded-lg hover:bg-white/10 transition">Cancelar</button>
                <button id="modalConfirm" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div id="logModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="glassmorphism border border-white/10 rounded-2xl p-6 w-full max-w-md">
            <h3 id="logModalTitle" class="text-lg font-semibold mb-4">Registrar Atividade</h3>
            <div class="mb-4">
                <label class="block text-sm text-white/70 mb-1">Data</label>
                <input type="date" id="logDate" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="mb-4">
                <label class="block text-sm text-white/70 mb-1">Hora</label>
                <input type="time" id="logTime" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="flex justify-end space-x-2">
                <button id="logModalCancel" class="px-4 py-2 rounded-lg hover:bg-white/10 transition">Cancelar</button>
                <button id="logModalConfirm" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition">Registrar</button>
                <button id="logModalDelete" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition hidden">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Backup/Restauração -->
    <div id="dataModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="glassmorphism border border-white/10 rounded-2xl p-6 w-full max-w-md">
            <h3 id="dataModalTitle" class="text-lg font-semibold mb-4">Backup de Dados</h3>
            <div id="backupContent" class="mb-4">
                <p class="text-sm text-white/70 mb-2">Copie o texto abaixo para fazer backup dos seus dados:</p>
                <textarea id="backupData" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2" rows="6" readonly></textarea>
                <button id="copyBackupBtn" class="w-full py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition">Copiar para Área de Transferência</button>
            </div>
            <div id="restoreContent" class="mb-4 hidden">
                <p class="text-sm text-white/70 mb-2">Cole seus dados de backup abaixo:</p>
                <textarea id="restoreData" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2" rows="6"></textarea>
                <button id="confirmRestoreBtn" class="w-full py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition">Restaurar Dados</button>
            </div>
            <div class="flex justify-end">
                <button id="dataModalClose" class="px-4 py-2 rounded-lg hover:bg-white/10 transition">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="glassmorphism border border-white/10 rounded-2xl p-6 w-full max-w-md">
            <h3 id="confirmModalTitle" class="text-lg font-semibold mb-4">Confirmação</h3>
            <p id="confirmModalMessage" class="mb-6">Tem certeza que deseja realizar esta ação?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirmModalCancel" class="px-4 py-2 rounded-lg hover:bg-white/10 transition">Cancelar</button>
                <button id="confirmModalConfirm" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplicação
        const state = {
            currentView: 'dashboard', // 'dashboard', 'habitDetail', 'generalNotes'
            currentHabitId: null,
            editingNoteId: null,
            editingLogId: null,
            calendarView: 'month', // 'month' ou 'year'
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            modalContext: null, // 'habitName', 'habitNote', 'generalNote'
            dataModalContext: null, // 'backup', 'restore'
            dataToRestore: null
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar dados do localStorage
            loadData();

            // Configurar event listeners
            setupEventListeners();

            // Atualizar a UI inicial
            updateUI();
        });

        // Estrutura de dados
        let appData = {
            habits: [],
            generalNotes: [],
            lastActivity: null
        };

        // Carregar dados do localStorage
        function loadData() {
            const savedData = localStorage.getItem('habitFlowData');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
        }

        // NOVO: Função dedicada apenas a salvar no localStorage
        function persistData() {
            localStorage.setItem('habitFlowData', JSON.stringify(appData));
        }

        // MODIFICADO: saveData agora persiste e depois atualiza a UI
        function saveData() {
            persistData();
            updateUI();
        }

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('logoTitle').addEventListener('click', () => showDashboard());
            document.getElementById('dashboardLink').addEventListener('click', () => showDashboard());
            document.getElementById('notesLink').addEventListener('click', () => showGeneralNotes());
            document.getElementById('backToDashboard').addEventListener('click', () => showDashboard());
            document.getElementById('backFromNotes').addEventListener('click', () => showDashboard());
            document.getElementById('newHabitForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const habitName = document.getElementById('habitName').value.trim();
                if (habitName) {
                    addHabit(habitName);
                    document.getElementById('habitName').value = '';
                }
            });
            document.getElementById('monthViewBtn').addEventListener('click', () => {
                state.calendarView = 'month';
                updateCalendar();
            });
            document.getElementById('yearViewBtn').addEventListener('click', () => {
                state.calendarView = 'year';
                updateCalendar();
            });
            document.getElementById('modalCancel').addEventListener('click', () => {
                document.getElementById('universalModal').classList.add('hidden');
            });
            document.getElementById('modalConfirm').addEventListener('click', () => {
                handleModalConfirm();
            });
            document.getElementById('logModalCancel').addEventListener('click', () => {
                document.getElementById('logModal').classList.add('hidden');
            });
            document.getElementById('logModalConfirm').addEventListener('click', () => {
                handleLogModalConfirm();
            });
            document.getElementById('logModalDelete').addEventListener('click', () => {
                handleLogModalDelete();
            });
            document.getElementById('dataModalClose').addEventListener('click', () => {
                document.getElementById('dataModal').classList.add('hidden');
            });
            document.getElementById('copyBackupBtn').addEventListener('click', () => {
                copyToClipboard('backupData');
            });
            document.getElementById('confirmRestoreBtn').addEventListener('click', () => {
                // A lógica de restauração agora começa em handleRestore()
            });
            document.getElementById('confirmModalCancel').addEventListener('click', () => {
                document.getElementById('confirmModal').classList.add('hidden');
            });
            document.getElementById('confirmModalConfirm').addEventListener('click', () => {
                handleConfirmModalConfirm();
            });
            document.getElementById('backupBtn').addEventListener('click', handleBackup);
            document.getElementById('restoreBtn').addEventListener('click', handleRestore);
            document.getElementById('clearDataBtn').addEventListener('click', () => {
                showConfirmModal('Limpar todos os dados', 'Tem certeza que deseja apagar PERMANENTEMENTE todos os hábitos e anotações? Esta ação não pode ser desfeita.', 'clearData');
            });
            document.getElementById('generalNotesList').addEventListener('click', (e) => {
                if (e.target.matches('.toggle-content-btn')) {
                    const noteElement = e.target.closest('.general-note');
                    const shortContent = noteElement.querySelector('.short-content');
                    const fullContent = noteElement.querySelector('.full-content');
                    noteElement.classList.toggle('is-expanded');
                    if (noteElement.classList.contains('is-expanded')) {
                        shortContent.classList.add('hidden');
                        fullContent.classList.remove('hidden');
                        e.target.textContent = 'Ver menos...';
                    } else {
                        shortContent.classList.remove('hidden');
                        fullContent.classList.add('hidden');
                        e.target.textContent = 'Ver mais...';
                    }
                }
            });
            // NOVO: Event listener para fechar modais com a tecla ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('#universalModal, #logModal, #dataModal, #confirmModal');
                    modals.forEach(modal => {
                        if (!modal.classList.contains('hidden')) {
                            modal.classList.add('hidden');
                        }
                    });
                }
            });
        }

        // Funções de navegação
        function showDashboard() {
            state.currentView = 'dashboard';
            updateUI();
        }

        function showHabitDetail(habitId) {
            state.currentView = 'habitDetail';
            state.currentHabitId = habitId;
            updateUI();
        }

        function showGeneralNotes() {
            state.currentView = 'generalNotes';
            updateUI();
        }

        // Funções de atualização da UI
        function updateUI() {
            // Esconder todas as views
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('habitDetailView').classList.add('hidden');
            document.getElementById('generalNotesView').classList.add('hidden');

            // NOVO: Renderiza a lista de hábitos na barra lateral em toda atualização
            renderSidebarHabitsList();

            // Mostrar a view correta
            if (state.currentView === 'dashboard') {
                document.getElementById('dashboardView').classList.remove('hidden');
                renderHabits();
            } else if (state.currentView === 'habitDetail') {
                document.getElementById('habitDetailView').classList.remove('hidden');
                renderHabitDetail();
            } else if (state.currentView === 'generalNotes') {
                document.getElementById('generalNotesView').classList.remove('hidden');
                renderGeneralNotes();
            }
        }

        function renderHabits() {
            const container = document.getElementById('habitsContainer');
            const noHabitsMessage = document.getElementById('noHabitsMessage');

            if (appData.habits.length === 0) {
                noHabitsMessage.classList.remove('hidden');
                container.innerHTML = '';
                container.appendChild(noHabitsMessage);
                return;
            }

            noHabitsMessage.classList.add('hidden');
            container.innerHTML = '';

            appData.habits.forEach(habit => {
                const habitCard = document.createElement('div');
                habitCard.className = 'glassmorphism border border-white/10 rounded-2xl p-4 habit-card cursor-pointer hover:border-white/20 transition flex flex-col';
                habitCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="font-medium truncate-text pr-2">${habit.name}</h3>
                        <div class="text-xs bg-white/5 px-2 py-1 rounded-full whitespace-nowrap">${formatStreak(calculateHabitStreak(habit.id))}</div>
                    </div>
                    <div class="mt-2 text-sm text-white/60">
                        ${habit.logs && habit.logs.length > 0 ? `${habit.logs.length} registros` : 'Nenhum registro'}
                    </div>
                `;
                habitCard.addEventListener('click', () => showHabitDetail(habit.id));
                container.appendChild(habitCard);
            });
        }

        function renderHabitDetail() {
            const habit = appData.habits.find(h => h.id === state.currentHabitId);
            if (!habit) {
                showDashboard();
                return;
            }

            document.getElementById('habitNameTitle').textContent = habit.name;
            document.getElementById('editHabitName').addEventListener('click', () => {
                showEditModal('Editar nome do hábito', habit.name, 'habitName');
            });

            updateCalendar();
            renderRecentLogs();
            renderHabitNotes();

            document.getElementById('addNoteBtn').onclick = () => {
                 showEditModal('Nova anotação', '', 'habitNote');
            };
        }

        function updateCalendar() {
            if (state.calendarView === 'month') {
                document.getElementById('monthCalendar').classList.remove('hidden');
                document.getElementById('yearCalendar').classList.add('hidden');
                document.getElementById('monthViewBtn').classList.add('bg-blue-500');
                document.getElementById('monthViewBtn').classList.remove('bg-white/5');
                document.getElementById('yearViewBtn').classList.remove('bg-blue-500');
                document.getElementById('yearViewBtn').classList.add('bg-white/5');
                renderMonthCalendar();
            } else {
                document.getElementById('monthCalendar').classList.add('hidden');
                document.getElementById('yearCalendar').classList.remove('hidden');
                document.getElementById('monthViewBtn').classList.remove('bg-blue-500');
                document.getElementById('monthViewBtn').classList.add('bg-white/5');
                document.getElementById('yearViewBtn').classList.add('bg-blue-500');
                document.getElementById('yearViewBtn').classList.remove('bg-white/5');
                renderYearCalendar();
            }
        }

        function renderMonthCalendar() {
            const monthDaysContainer = document.getElementById('monthDays');
            monthDaysContainer.innerHTML = '';

            const habit = appData.habits.find(h => h.id === state.currentHabitId);
            if (!habit) return;

            const firstDay = new Date(state.currentYear, state.currentMonth, 1);
            const lastDay = new Date(state.currentYear, state.currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();

            // Dias vazios no início
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-8';
                monthDaysContainer.appendChild(emptyDay);
            }

            // Dias do mês
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(state.currentYear, state.currentMonth, day);
                const dateStr = formatDate(date);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'h-8 flex items-center justify-center rounded-full cursor-pointer hover:bg-white/10 transition';
                
                // Verificar se há logs para este dia
                const hasLog = habit.logs && habit.logs.some(log => log.date.startsWith(dateStr));
                if (hasLog) {
                    dayElement.classList.add('bg-blue-500/30');
                }
                
                dayElement.textContent = day;
                dayElement.addEventListener('click', () => showLogModal(date));
                monthDaysContainer.appendChild(dayElement);
            }
        }

        function renderYearCalendar() {
            const yearContainer = document.getElementById('yearCalendar');
            yearContainer.innerHTML = '';
            // Muda o layout da grade para exibir os meses de forma mais espaçosa
            yearContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';

            const habit = appData.habits.find(h => h.id === state.currentHabitId);
            if (!habit) return;

            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const dayNames = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];

            for (let month = 0; month < 12; month++) {
                const monthWrapper = document.createElement('div');
                monthWrapper.className = 'glassmorphism border border-white/10 rounded-xl p-3 text-sm';

                // Título do Mês (Clicável)
                const monthTitle = document.createElement('h4');
                monthTitle.className = 'font-semibold text-center mb-2 cursor-pointer hover:text-blue-400';
                monthTitle.textContent = monthNames[month];
                monthTitle.onclick = () => {
                    state.currentMonth = month;
                    state.calendarView = 'month';
                    updateCalendar();
                };
                monthWrapper.appendChild(monthTitle);

                // Grid dos dias da semana
                const daysHeader = document.createElement('div');
                daysHeader.className = 'grid grid-cols-7 gap-1 text-xs text-center text-white/50 mb-1';
                dayNames.forEach(name => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.textContent = name;
                    daysHeader.appendChild(dayNameEl);
                });
                monthWrapper.appendChild(daysHeader);

                // Grid dos dias
                const daysContainer = document.createElement('div');
                daysContainer.className = 'grid grid-cols-7 gap-1';

                const firstDayOfMonth = new Date(state.currentYear, month, 1).getDay();
                const daysInMonth = new Date(state.currentYear, month + 1, 0).getDate();

                // Adiciona células vazias para o início do mês
                for (let i = 0; i < firstDayOfMonth; i++) {
                    daysContainer.appendChild(document.createElement('div'));
                }

                // Adiciona os dias do mês
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'h-6 w-6 flex items-center justify-center rounded-full hover:bg-white/10 transition cursor-pointer';
                    dayCell.textContent = day;
                    const currentDate = new Date(state.currentYear, month, day);

                    // Verifica se há log neste dia
                    const hasLog = habit.logs && habit.logs.some(log => log.date.startsWith(formatDate(currentDate)));
                    if (hasLog) {
                        dayCell.classList.add('bg-blue-500/50', 'border', 'border-blue-400');
                    }

                    dayCell.onclick = () => showLogModal(currentDate);
                    daysContainer.appendChild(dayCell);
                }

                monthWrapper.appendChild(daysContainer);
                yearContainer.appendChild(monthWrapper);
            }
        }

        function renderRecentLogs() {
            const container = document.getElementById('recentLogs');
            if (!container) return;
            container.innerHTML = '';

            const habit = appData.habits.find(h => h.id === state.currentHabitId);
            if (!habit || !habit.logs || habit.logs.length === 0) {
                container.innerHTML = '<p class="text-sm text-white/40 text-center py-4">Nenhum registro encontrado</p>';
                return;
            }

            const sortedLogs = [...habit.logs].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedLogs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = 'glassmorphism border border-white/10 rounded-lg p-3 flex justify-between items-center cursor-pointer';
                const logDate = new Date(log.date);
                const dateStr = logDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                const timeStr = logDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                logElement.innerHTML = `
                    <div>
                        <span class="text-sm">${dateStr}</span>
                        <span class="text-xs text-white/60 ml-2">${timeStr}</span>
                    </div>
                    <button class="text-xs text-red-400 hover:text-red-300 transition" data-log-id="${log.id}">Excluir</button>
                `;
                logElement.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirmModal('Excluir registro', 'Tem certeza que deseja excluir este registro?', 'deleteLog', log.id);
                });
                logElement.addEventListener('click', () => {
                    showLogModal(new Date(log.date), log.id);
                });
                container.appendChild(logElement);
            });
        }

        function renderHabitNotes() {
            const container = document.getElementById('habitNotes');
            if (!container) return;
            container.innerHTML = '';

            const habit = appData.habits.find(h => h.id === state.currentHabitId);
            if (!habit || !habit.notes || habit.notes.length === 0) {
                container.innerHTML = '<p class="text-sm text-white/40 text-center py-4">Nenhuma anotação.</p>';
                return;
            }
            const sortedNotes = [...habit.notes].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            sortedNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'glassmorphism border border-white/10 rounded-lg p-3';
                noteElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-white/60">${new Date(note.createdAt).toLocaleDateString('pt-BR')}</span>
                        <div class="flex space-x-2">
                            <button class="text-xs hover:text-blue-400 transition" data-note-id="${note.id}">Editar</button>
                            <button class="text-xs hover:text-red-400 transition" data-note-id="${note.id}">Excluir</button>
                        </div>
                    </div>
                    <p class="text-sm whitespace-pre-line break-word">${note.content}</p>
                `;
                const buttons = noteElement.querySelectorAll('button');
                buttons[0].addEventListener('click', (e) => {
                    showEditModal('Editar anotação', note.content, 'habitNote', note.id);
                });
                buttons[1].addEventListener('click', (e) => {
                    showConfirmModal('Excluir anotação', 'Tem certeza?', 'deleteHabitNote', note.id);
                });
                container.appendChild(noteElement);
            });
        }

        function renderGeneralNotes() {
            const container = document.getElementById('generalNotesList');
            container.innerHTML = '';
            document.getElementById('addGeneralNoteBtn').addEventListener('click', () => {
                showEditModal('Nova anotação geral', '', 'generalNote');
            });
            if (appData.generalNotes.length === 0) {
                container.innerHTML = '<p class="text-sm text-white/40 text-center py-4">Nenhuma anotação encontrada</p>';
                return;
            }
            const sortedNotes = [...appData.generalNotes].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            sortedNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'general-note glassmorphism border border-white/10 rounded-lg p-3 mb-3';
                const noteDate = new Date(note.createdAt).toLocaleDateString('pt-BR');
                const characterLimit = 250;
                let contentHTML = '';
                if (note.content.length > characterLimit) {
                    contentHTML = `
                        <div class="short-content">
                            <p class="text-sm whitespace-pre-line break-word">${note.content.substring(0, characterLimit)}...</p>
                        </div>
                        <div class="full-content hidden">
                            <p class="text-sm whitespace-pre-line break-word">${note.content}</p>
                        </div>
                        <button class="toggle-content-btn text-xs text-blue-400 hover:underline mt-2">Ver mais...</button>
                    `;
                } else {
                    contentHTML = `<p class="text-sm whitespace-pre-line break-word">${note.content}</p>`;
                }
                noteElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-white/60">${noteDate}</span>
                        <div class="flex space-x-2">
                            <button class="text-xs hover:text-blue-400 transition" onclick="showEditModal('Editar anotação geral', '${note.content.replace(/'/g, "\'")}', 'generalNote', '${note.id}')">Editar</button>
                            <button class="text-xs hover:text-red-400 transition" onclick="showConfirmModal('Excluir anotação geral', 'Tem certeza?', 'deleteGeneralNote', '${note.id}')">Excluir</button>
                        </div>
                    </div>
                    ${contentHTML}
                `;
                container.appendChild(noteElement);
            });
        }

        // Funções de CRUD para hábitos
        function addHabit(name) {
            const newHabit = {
                id: generateId(),
                name: name,
                createdAt: new Date().toISOString(),
                logs: [],
                notes: []
            };
            
            appData.habits.push(newHabit);
            saveData();
        }

        function updateHabitName(habitId, newName) {
            const habit = appData.habits.find(h => h.id === habitId);
            if (habit) {
                habit.name = newName;
                saveData();
            }
        }

        function deleteHabit(habitId) {
            appData.habits = appData.habits.filter(h => h.id !== habitId);
            saveData();
            if (state.currentView === 'habitDetail' && state.currentHabitId === habitId) {
                showDashboard();
            }
        }

        // Funções de CRUD para logs
        function addLog(habitId, dateTime, logId = null) {
            const habit = appData.habits.find(h => h.id === habitId);
            if (!habit) return;

            if (logId) {
                // Atualizar log existente
                const logIndex = habit.logs.findIndex(l => l.id === logId);
                if (logIndex !== -1) {
                    habit.logs[logIndex].date = dateTime.toISOString();
                }
            } else {
                // Adicionar novo log
                const newLog = {
                    id: generateId(),
                    date: dateTime.toISOString()
                };
                habit.logs.push(newLog);
            }

            // Atualizar última atividade
            appData.lastActivity = new Date().toISOString();
            
            saveData();
            updateCalendar();
        }

        function deleteLog(habitId, logId) {
            const habit = appData.habits.find(h => h.id === habitId);
            if (habit) {
                habit.logs = habit.logs.filter(l => l.id !== logId);
                saveData();
                updateCalendar();
            }
        }

        // Funções de CRUD para anotações
        function addHabitNote(habitId, content, noteId = null) {
            const habit = appData.habits.find(h => h.id === habitId);
            if (!habit) return;

            if (noteId) {
                // Atualizar anotação existente
                const noteIndex = habit.notes.findIndex(n => n.id === noteId);
                if (noteIndex !== -1) {
                    habit.notes[noteIndex].content = content;
                    habit.notes[noteIndex].updatedAt = new Date().toISOString();
                }
            } else {
                // Adicionar nova anotação
                const newNote = {
                    id: generateId(),
                    content: content,
                    createdAt: new Date().toISOString()
                };
                habit.notes.push(newNote);
            }
            
            saveData();
        }

        function deleteHabitNote(habitId, noteId) {
            const habit = appData.habits.find(h => h.id === habitId);
            if (habit) {
                habit.notes = habit.notes.filter(n => n.id !== noteId);
                saveData();
            }
        }

        function addGeneralNote(content, noteId = null) {
            if (noteId) {
                // Atualizar anotação existente
                const noteIndex = appData.generalNotes.findIndex(n => n.id === noteId);
                if (noteIndex !== -1) {
                    appData.generalNotes[noteIndex].content = content;
                    appData.generalNotes[noteIndex].updatedAt = new Date().toISOString();
                }
            } else {
                // Adicionar nova anotação
                const newNote = {
                    id: generateId(),
                    content: content,
                    createdAt: new Date().toISOString()
                };
                appData.generalNotes.push(newNote);
            }
            
            saveData();
        }

        function deleteGeneralNote(noteId) {
            appData.generalNotes = appData.generalNotes.filter(n => n.id !== noteId);
            saveData();
        }

        // Funções de modal
        function showEditModal(title, initialValue, context, itemId = null) {
            state.modalContext = context;
            
            if (context === 'habitNote' || context === 'generalNote') {
                state.editingNoteId = itemId;
            }
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalInput').value = initialValue;
            document.getElementById('universalModal').classList.remove('hidden');
            document.getElementById('modalInput').focus();
        }

        function handleModalConfirm() {
            const newValue = document.getElementById('modalInput').value.trim();
            if (!newValue) return;

            if (state.modalContext === 'habitName' && state.currentHabitId) {
                updateHabitName(state.currentHabitId, newValue);
                document.getElementById('habitNameTitle').textContent = newValue;
            } else if (state.modalContext === 'habitNote' && state.currentHabitId) {
                addHabitNote(state.currentHabitId, newValue, state.editingNoteId);
            } else if (state.modalContext === 'generalNote') {
                addGeneralNote(newValue, state.editingNoteId);
            }

            document.getElementById('universalModal').classList.add('hidden');
            state.modalContext = null;
            state.editingNoteId = null;
        }

        function showLogModal(date, logId = null) {
            state.editingLogId = logId;
            
            const modalTitle = logId ? 'Editar Registro' : 'Novo Registro';
            document.getElementById('logModalTitle').textContent = modalTitle;
            
            // Formatar data para o input date (YYYY-MM-DD)
            const dateStr = date.toISOString().split('T')[0];
            document.getElementById('logDate').value = dateStr;
            
            // Formatar hora para o input time (HH:MM)
            const timeStr = date.toTimeString().substring(0, 5);
            document.getElementById('logTime').value = timeStr;
            
            // Mostrar/ocultar botão de excluir
            if (logId) {
                document.getElementById('logModalDelete').classList.remove('hidden');
            } else {
                document.getElementById('logModalDelete').classList.add('hidden');
            }
            
            document.getElementById('logModal').classList.remove('hidden');
        }

        function handleLogModalConfirm() {
            const dateStr = document.getElementById('logDate').value;
            const timeStr = document.getElementById('logTime').value;
            
            if (!dateStr || !timeStr) return;
            
            const dateTime = new Date(`${dateStr}T${timeStr}`);
            
            if (state.currentHabitId) {
                addLog(state.currentHabitId, dateTime, state.editingLogId);
            }
            
            document.getElementById('logModal').classList.add('hidden');
            state.editingLogId = null;
        }

        function handleLogModalDelete() {
            if (state.currentHabitId && state.editingLogId) {
                deleteLog(state.currentHabitId, state.editingLogId);
            }
            
            document.getElementById('logModal').classList.add('hidden');
            state.editingLogId = null;
        }

        function showConfirmModal(title, message, action, itemId = null) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            
            // Armazenar a ação e o ID do item no modal
            document.getElementById('confirmModal').setAttribute('data-action', action);
            document.getElementById('confirmModal').setAttribute('data-item-id', itemId || '');
            
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function handleConfirmModalConfirm() {
            const action = document.getElementById('confirmModal').getAttribute('data-action');
            const itemId = document.getElementById('confirmModal').getAttribute('data-item-id');
            let shouldReload = false;
            if (action === 'deleteHabit' && state.currentHabitId) {
                deleteHabit(state.currentHabitId);
            } else if (action === 'deleteLog' && state.currentHabitId && itemId) {
                deleteLog(state.currentHabitId, itemId);
            } else if (action === 'deleteHabitNote' && state.currentHabitId && itemId) {
                deleteHabitNote(state.currentHabitId, itemId);
            } else if (action === 'deleteGeneralNote' && itemId) {
                deleteGeneralNote(itemId);
            } else if (action === 'clearData') {
                clearAllData();
                shouldReload = true;
            } else if (action === 'restoreData' && state.dataToRestore) {
                appData = state.dataToRestore;
                state.dataToRestore = null;
                persistData();
                shouldReload = true;
            }
            document.getElementById('confirmModal').classList.add('hidden');
            if (shouldReload) {
                location.reload();
            } else {
                updateUI();
            }
        }

        function handleBackup() {
            try {
                const dataStr = JSON.stringify(appData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const today = new Date().toISOString().slice(0, 10);
                a.href = url;
                a.download = `habitflow-backup-${today}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Erro ao criar backup:", error);
                alert("Não foi possível criar o arquivo de backup.");
            }
        }

        function handleRestore() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const restoredData = JSON.parse(event.target.result);

                        // Validação MELHORADA: Apenas checa se 'habits' é um array.
                        // Isso torna a restauração compatível com versões mais antigas do backup.
                        if (restoredData && Array.isArray(restoredData.habits)) {
                            // Garante que as novas propriedades existam no objeto restaurado para evitar erros futuros
                            if (!restoredData.generalNotes) {
                                restoredData.generalNotes = [];
                            }
                            if (!restoredData.lastActivity) {
                                restoredData.lastActivity = null;
                            }

                            state.dataToRestore = restoredData;
                            showConfirmModal('Restaurar Dados', 'Isso substituirá todos os seus dados atuais pelos dados do arquivo. Deseja continuar?', 'restoreData');
                        } else {
                            alert('Arquivo de backup inválido ou corrompido.');
                        }
                    } catch (error) {
                        console.error("Erro ao ler o arquivo de backup:", error);
                        alert('Erro ao ler o arquivo de backup. Verifique se o arquivo é um JSON válido.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            // Remove diretamente a chave do localStorage, que é mais garantido.
            localStorage.removeItem('habitFlowData');

            // Reseta o estado da aplicação na memória.
            appData = {
                habits: [],
                generalNotes: [],
                lastActivity: null
            };

            // Salva o estado limpo e atualiza a interface.
            saveData();
        }

        // Funções de utilidade
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatStreak(streak) {
            if (!streak) return '0d 0h 0m 0s';
            
            const days = Math.floor(streak / (1000 * 60 * 60 * 24));
            const hours = Math.floor((streak % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((streak % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((streak % (1000 * 60)) / 1000);
            
            return `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');
            
            // Feedback visual
            const originalText = document.getElementById('copyBackupBtn').textContent;
            document.getElementById('copyBackupBtn').textContent = 'Copiado!';
            setTimeout(() => {
                document.getElementById('copyBackupBtn').textContent = originalText;
            }, 2000);
        }

        // Funções de contador de sequência
        function calculateHabitStreak(habitId) {
            const habit = appData.habits.find(h => h.id === habitId);
            if (!habit || !habit.logs || habit.logs.length === 0) return 0;
            
            // Ordenar logs por data (mais recente primeiro)
            const sortedLogs = [...habit.logs].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let streak = 0;
            let lastDate = new Date();
            
            for (const log of sortedLogs) {
                const logDate = new Date(log.date);
                
                // Se a diferença for maior que 24h, quebra a sequência
                if ((lastDate - logDate) > (24 * 60 * 60 * 1000)) {
                    break;
                }
                
                streak += lastDate - logDate;
                lastDate = logDate;
            }
            
            return streak;
        }

        // NOVO: Função para renderizar a lista de hábitos na barra lateral
        function renderSidebarHabitsList() {
            const container = document.getElementById('sidebarHabitsList');
            container.innerHTML = ''; // Limpa a lista antes de renderizar

            if (!appData.habits || appData.habits.length === 0) {
                container.innerHTML = '<p class="px-2 text-xs text-white/40">Nenhum hábito criado.</p>';
                return;
            }

            // Ordena os hábitos por data de criação para consistência
            const sortedHabits = [...appData.habits].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            sortedHabits.forEach(habit => {
                const habitLink = document.createElement('a');
                habitLink.href = '#';
                habitLink.className = 'flex items-center p-2 text-sm rounded-lg hover:bg-white/10 transition truncate';
                habitLink.textContent = habit.name;

                // Adiciona um destaque visual se o hábito selecionado for o atual
                if (state.currentView === 'habitDetail' && state.currentHabitId === habit.id) {
                    habitLink.classList.add('bg-white/10', 'text-white');
                } else {
                    habitLink.classList.add('text-white/70');
                }

                habitLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showHabitDetail(habit.id);
                });
                container.appendChild(habitLink);
            });
        }
    </script>
</body>
</html>